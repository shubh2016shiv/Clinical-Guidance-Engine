# Asclepius Healthcare Chatbot - Infrastructure Docker Compose Configuration
# This file defines the infrastructure services for the Asclepius Healthcare Chatbot:
# - Milvus: Vector database for pharmaceutical drug embeddings
# - MongoDB: Document database for conversation storage
# - Redis: Cache service for performance optimization
# - Supporting services: etcd, MinIO, Attu UI

name: asclepius-infrastructure

version: '3.5'

services:

  etcd:

    container_name: milvus-etcd

    image: quay.io/coreos/etcd:v3.5.5

    environment:

      - ETCD_AUTO_COMPACTION_MODE=revision

      - ETCD_AUTO_COMPACTION_RETENTION=1000

      - ETCD_QUOTA_BACKEND_BYTES=4294967296

      - ETCD_SNAPSHOT_COUNT=50000

    volumes:

      - ${DOCKER_VOLUME_DIRECTORY:-.}/volumes/etcd:/etcd

    command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd

    healthcheck:

      test: ["CMD", "etcdctl", "endpoint", "health"]

      interval: 30s

      timeout: 20s

      retries: 3

    networks:

      - milvus

    labels:

      - "project=asclepius-healthcare-chatbot"

      - "service=etcd"

      - "description=Asclepius Healthcare Chatbot - etcd service for Milvus"

  minio:

    container_name: milvus-minio

    image: minio/minio:RELEASE.2023-03-20T20-16-18Z

    environment:

      MINIO_ACCESS_KEY: minioadmin

      MINIO_SECRET_KEY: minioadmin

    volumes:

      - ${DOCKER_VOLUME_DIRECTORY:-.}/volumes/minio:/minio_data

    command: minio server /minio_data

    healthcheck:

      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]

      interval: 30s

      timeout: 20s

      retries: 3

    ports:

      - "9000:9000"

      - "9001:9001"

    networks:

      - milvus

    labels:

      - "project=asclepius-healthcare-chatbot"

      - "service=minio"

      - "description=Asclepius Healthcare Chatbot - MinIO object storage for Milvus"

  attu:

    container_name: attu

    image: zilliz/attu:v2.2.8

    environment:

      MILVUS_URL: milvus-standalone:19530

    ports:

      - "8000:3000"

    depends_on:

      - standalone

    networks:

      - milvus

    labels:

      - "project=asclepius-healthcare-chatbot"

      - "service=attu"

      - "description=Asclepius Healthcare Chatbot - Attu UI for Milvus management"

  standalone:

    container_name: milvus-standalone

    image: milvusdb/milvus:v2.2.16

    command: ["milvus", "run", "standalone"]

    environment:

      ETCD_ENDPOINTS: etcd:2379

      MINIO_ADDRESS: minio:9000

    volumes:

      - ${DOCKER_VOLUME_DIRECTORY:-.}/volumes/milvus:/var/lib/milvus

    healthcheck:

      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]

      interval: 30s

      start_period: 90s

      timeout: 20s

      retries: 3

    ports:

      - "19530:19530"

      - "9091:9091"

    depends_on:

      - "etcd"

      - "minio"

    networks:

      - milvus

    labels:

      - "project=asclepius-healthcare-chatbot"

      - "service=milvus-standalone"

      - "description=Asclepius Healthcare Chatbot - Milvus vector database"

  mongodb:

    container_name: mongodb

    image: mongo:7.0

    environment:

      MONGO_INITDB_ROOT_USERNAME: admin

      MONGO_INITDB_ROOT_PASSWORD: password123

    volumes:

      - ${DOCKER_VOLUME_DIRECTORY:-.}/volumes/mongodb:/data/db

    ports:

      - "27017:27017"

    healthcheck:

      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]

      interval: 30s

      timeout: 10s

      retries: 3

      start_period: 40s

    networks:

      - milvus

    labels:

      - "project=asclepius-healthcare-chatbot"

      - "service=mongodb"

      - "description=Asclepius Healthcare Chatbot - MongoDB document database"

  redis:

    container_name: redis

    image: redis:7.2-alpine

    command: redis-server --requirepass redis123

    volumes:

      - ${DOCKER_VOLUME_DIRECTORY:-.}/volumes/redis:/data

    ports:

      - "6379:6379"

    healthcheck:

      test: ["CMD", "redis-cli", "-a", "redis123", "ping"]

      interval: 30s

      timeout: 10s

      retries: 3

      start_period: 10s

    networks:

      - milvus

    labels:

      - "project=asclepius-healthcare-chatbot"

      - "service=redis"

      - "description=Asclepius Healthcare Chatbot - Redis cache service"

networks:

  milvus:

    name: asclepius-network
    
    labels:
      - "project=asclepius-healthcare-chatbot"
      - "description=Asclepius Healthcare Chatbot Infrastructure Network"

